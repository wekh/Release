name: OKTV Release update

on:
  schedule:
    - cron: '0 0 */2 * *'  # 每2天自动运行
  workflow_dispatch:

permissions:
  contents: write  # 允许修改 release 内容

jobs:
  update-ok-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install requests
        run: python -m pip install --upgrade pip requests

      - name: Download and rename APK, extract first version
        id: download_apk
        run: |
          python - <<'EOF'
          import requests, os, re, datetime

          OWNER, REPO, PATH = "youhunwl", "TVAPP", "影视/OK影视"
          file_map = {
              "自带X5": "leanback-armeabi_v7a_x5.apk",
              "OK影视-电视版": "leanback-armeabi_v7a.apk",
              "OK影视-手机版": "mobile-arm64_v8a.apk",
              "海信专版": "Hisense-TV.apk"
          }

          DOWNLOAD_DIR = "ok_apk_update/apk"
          os.makedirs(DOWNLOAD_DIR, exist_ok=True)

          version_str = "最新"

          res = requests.get(f"https://api.github.com/repos/{OWNER}/{REPO}/contents/{PATH}")
          res.raise_for_status()

          for f in res.json():
              for key, save_name in file_map.items():
                  if f['name'].startswith(key):
                      print(f"Downloading {f['name']} → {save_name}")
                      r = requests.get(f['download_url'])
                      r.raise_for_status()
                      with open(os.path.join(DOWNLOAD_DIR, save_name), "wb") as out:
                          out.write(r.content)
                      if version_str == "最新":
                          m = re.search(r'v?(\d+(?:\.\d+)+)', f['name'])
                          if m:
                              version_str = m.group(1)
                      break

          # 输出版本号供后续步骤使用
          with open(os.environ['GITHUB_OUTPUT'], 'a', encoding='utf-8') as gh_out:
              gh_out.write(f"version={version_str}\n")
          EOF

      - name: Check GitHub CLI version
        run: gh --version

      - name: Update or create OKTV release and upload new APKs
        run: |
          TAG="OKTV"
          VERSION="${{ steps.download_apk.outputs.version }}"
          TITLE="OKTV ${VERSION}"
          UPDATED_AT=$(date +"%Y-%m-%d %H:%M CST")
          
          echo "Checking if release exists..."
          RELEASE_ID=$(gh api "/repos/${{ github.repository }}/releases/tags/$TAG" --jq '.id' 2>/dev/null || echo "")

          if [ -z "$RELEASE_ID" ]; then
            echo "Release not found. Creating new one..."
            gh release create "$TAG" -t "$TITLE" -n "自动更新版本 ${VERSION}\n更新时间：${UPDATED_AT}"
          else
            echo "Release exists. Updating title, body, and refreshing time..."
            gh api \
              -X PATCH \
              -H "Accept: application/vnd.github+json" \
              "/repos/${{ github.repository }}/releases/$RELEASE_ID" \
              -f tag_name="$TAG" \
              -f name="$TITLE" \
              -f body="自动更新版本 ${VERSION}\n更新时间：${UPDATED_AT}"
          fi

          echo "Uploading or replacing new APK files..."
          for f in ok_apk_update/apk/*; do
            echo "→ $f"
            gh release upload "$TAG" "$f" --clobber
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
