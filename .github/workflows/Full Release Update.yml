name: Full Release Update

on:
  schedule:
    - cron: '0 0 */2 * *'  # 每2天自动运行
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release_update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install requests
        run: python -m pip install --upgrade pip requests

      ##############
      # OKTV APK下载与Release
      ##############
      - name: Download OKTV APKs and extract version
        id: download_oktv
        run: |
          python - <<'EOF'
          import requests, os, re

          OWNER, REPO, PATH = "youhunwl", "TVAPP", "影视/OK影视"
          file_map = {
              "自带X5": "leanback-armeabi_v7a_x5.apk",
              "OK影视-电视版": "leanback-armeabi_v7a.apk",
              "OK影视-手机版": "mobile-arm64_v8a.apk",
              "海信专版": "Hisense-TV.apk"
          }

          DOWNLOAD_DIR = "ok_apk_update/apk"
          os.makedirs(DOWNLOAD_DIR, exist_ok=True)

          version_str = "最新"

          res = requests.get(f"https://api.github.com/repos/{OWNER}/{REPO}/contents/{PATH}")
          res.raise_for_status()

          for f in res.json():
              for key, save_name in file_map.items():
                  if f['name'].startswith(key):
                      r = requests.get(f['download_url'])
                      r.raise_for_status()
                      with open(os.path.join(DOWNLOAD_DIR, save_name), "wb") as out:
                          out.write(r.content)
                      if version_str == "最新":
                          m = re.search(r'v?(\d+(?:\.\d+)+)', f['name'])
                          if m:
                              version_str = m.group(1)
                      break

          with open(os.environ['GITHUB_OUTPUT'], 'a', encoding='utf-8') as gh_out:
              gh_out.write(f"version={version_str}\n")
          EOF

      - name: Create/Update OKTV Release
        run: |
          TAG="OKTV"
          VERSION="${{ steps.download_oktv.outputs.version }}"
          UPDATED_AT=$(date +"%Y-%m-%d %H:%M CST")

          RELEASE_ID=$(gh api "/repos/${{ github.repository }}/releases/tags/$TAG" --jq '.id' 2>/dev/null || echo "")

          if [ -z "$RELEASE_ID" ]; then
            gh release create "$TAG" -t "OKTV ${VERSION}" -n "更新时间：${UPDATED_AT}" --draft=false
          else
            gh api -X PATCH -H "Accept: application/vnd.github+json" \
              "/repos/${{ github.repository }}/releases/$RELEASE_ID" \
              -f tag_name="$TAG" -f name="OKTV ${VERSION}" -f body="更新时间：${UPDATED_AT}"
          fi

          for f in ok_apk_update/apk/*; do
            gh release upload "$TAG" "$f" --clobber
          done

          # 确保 TAG 已推送到远程
          git tag -f $TAG
          git push origin $TAG -f
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      ##############
      # Latest 软件下载与Release
      ##############
      - name: Delete existing latest Release
        run: |
          releases=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/${{ github.repository }}/releases")
          release_ids=$(echo "$releases" | jq -r '.[] | select(.tag_name == "latest") | .id')
          for release_id in $release_ids; do
            curl -s -X DELETE -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/${{ github.repository }}/releases/$release_id"
          done

      - name: Create new latest Release
        id: create_latest
        run: |
          TAG_NAME="latest"
          RELEASE_NAME="Latest Release"
          response=$(curl -s -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{\"tag_name\": \"$TAG_NAME\", \"name\": \"$RELEASE_NAME\"}" \
            "https://api.github.com/repos/${{ github.repository }}/releases")
          release_id=$(echo "$response" | jq -r '.id')
          upload_url=$(echo "$response" | jq -r '.upload_url' | sed "s/{?name,label}//")
          echo "release_id=$release_id" >> $GITHUB_ENV
          echo "upload_url=$upload_url" >> $GITHUB_ENV

          # 确保 latest TAG 已推送到远程
          git tag -f $TAG_NAME
          git push origin $TAG_NAME -f

      - name: Download & Upload Latest Files
        run: |
          function download_upload() {
            REPO=$1
            MATCH=$2
            SAVE_NAME=$3
            MIME=$4

            url="https://api.github.com/repos/$REPO/releases/latest"
            download_url=$(curl -s "$url" | jq -r ".assets[] | select(.name | contains(\"$MATCH\")) | .browser_download_url")

            if [ -n "$download_url" ]; then
              curl -s -L -o "$SAVE_NAME" "$download_url"
              curl -s -X POST \
                -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -H "Content-Type: $MIME" \
                --data-binary @"$SAVE_NAME" \
                "${{ env.upload_url }}?name=$SAVE_NAME"
            fi
          }

          download_upload "2dust/v2rayN" "SelfContained.zip" "v2rayN-windows-64-SelfContained.zip" "application/zip"
          download_upload "2dust/v2rayNG" "_arm64-v8a.apk" "v2rayNG.apk" "application/vnd.android.package-archive"
          download_upload "MatsuriDayo/NekoBoxForAndroid" "arm64-v8a" "NekoBox.apk" "application/vnd.android.package-archive"
          download_upload "zetaloop/desktop" "GitHubDesktop-Windows-x64.exe" "GitHubDesktop-Windows-x64.exe" "application/octet-stream"

      - name: Update README.md
        run: |
          NEW_TIME=$(date +"%Y-%m-%d %H:%M CST")
          OKTV_VERSION="${{ steps.download_oktv.outputs.version }}"
          REPO_DESC="这是一个用于存放常用软件安装包的仓库，方便快速下载。"

          echo "$REPO_DESC" > README.md
          echo "" >> README.md
          echo "OK影视" >> README.md
          echo "更新版本 ${OKTV_VERSION}" >> README.md
          echo "更新时间：${NEW_TIME}" >> README.md
          echo "" >> README.md
          echo "latest Release" >> README.md
          echo "更新时间：${NEW_TIME}" >> README.md

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "自动更新 README.md：OKTV ${OKTV_VERSION}，latest Release 时间 ${NEW_TIME}" || echo "No changes to commit."
          git push
